<!DOCTYPE HTML>
<html>

<head>
    <title>eu.tarkovbot.tools</title>
    <meta charset="utf-8" />
</head>

<body>
    <script src="timers.js"></script>

    <script>

        var websocket = null;
        var pluginUUID = null;
        let intervalId = null;

        var DestinationEnum = Object.freeze({ "HARDWARE_AND_SOFTWARE": 0, "HARDWARE_ONLY": 1, "SOFTWARE_ONLY": 2 })

        function getTimeAgoString(timeDifference) {
            var seconds = Math.floor(timeDifference / 1000);
            var minutes = Math.floor(seconds / 60);
            var hours = Math.floor(minutes / 60);

            var timeAgo = "";

            if (hours > 0) {
                timeAgo += hours + "h ";
                minutes = minutes % 60;
            }
            if (minutes > 0 || timeAgo !== "") {
                timeAgo += minutes + "m ";
                seconds = seconds % 60;
            }
            if (seconds > 0 || timeAgo === "") {
                timeAgo += seconds + "s";
            }

            return timeAgo;
        }

        var goonsTrackerAction = {

            type: "eu.tarkovbot.tools.goonsgetlocation",


            onKeyDown: function (context, settings, coordinates, userDesiredState) {

                var token = "";
                if (settings != null && settings.hasOwnProperty('token') && settings["token"] !== '') {
                    goonsTrackerAction.SetTitle(context, "Loading...");
                    token = settings["token"];

                    var xhr = new XMLHttpRequest();
                    xhr.open("GET", "https://tarkovbot.eu/api/streamdeck/goonslocation", true);
                    xhr.setRequestHeader("AUTH-TOKEN", token);
                    xhr.onreadystatechange = function () {
                        if (xhr.readyState === 4) {
                            if (xhr.status === 200) {
                                var response = JSON.parse(xhr.responseText);
                                var location = response.location;
                                var reportedTime = new Date(response.reported);
                                var timeDifference = Date.now() - reportedTime;
                                var timeAgo = getTimeAgoString(timeDifference);

                                goonsTrackerAction.SetTitle(context, location + "\n" + timeAgo);
                            }
                            else if (xhr.status === 401) {
                                goonsTrackerAction.SetTitle(context, "Invalid\nToken");
                            }
                            else {
                                goonsTrackerAction.SetTitle(context, "Error");
                            }
                        }
                    };
                    xhr.send();

                } else {
                    goonsTrackerAction.SetTitle(context, "Invalid\nToken");
                }
            },

            onWillAppear: function (context, settings, coordinates) {
                this.SetTitle(context, "Press to\nGet\nLocation");
            },

            SetTitle: function (context, goonsLocation) {
                var json = {
                    "event": "setTitle",
                    "context": context,
                    "payload": {
                        "title": "" + goonsLocation,
                        "target": DestinationEnum.HARDWARE_AND_SOFTWARE,
                        "state": 2
                    }
                };

                websocket.send(JSON.stringify(json));
            }
        };



        var tarkovTimeAction = {

            type: "eu.tarkovbot.tools.tarkovtime",

            onWillAppear: function (context, settings, coordinates) {
                this.SetTitle(context, "Loading");

                function calculateTarkovTime() {
                    const currentDateTime = new Date();
                    const tarkovnasobic = 7;

                    const tarkovCASlevy = new Date(currentDateTime.getTime() * tarkovnasobic).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false, timeZone: 'Europe/Moscow' });
                    const tarkovCASpravy = new Date(currentDateTime.getTime() * tarkovnasobic - 43200000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit', hour12: false, timeZone: 'Europe/Moscow' });

                    tarkovTimeAction.SetTitle(context, tarkovCASlevy + "\n" + tarkovCASpravy);
                }

                calculateTarkovTime();

                if (intervalId !== null) {
                    clearInterval(intervalId);
                }

                intervalId = setInterval(calculateTarkovTime, 2000);

            },


            SetTitle: function (context, currentTime) {
                var json = {
                    "event": "setTitle",
                    "context": context,
                    "payload": {
                        "title": "" + currentTime,
                        "target": DestinationEnum.HARDWARE_AND_SOFTWARE,
                        "state": 2
                    }
                };

                websocket.send(JSON.stringify(json));
            }
        };

        var traderrestockAction = {

            type: "eu.tarkovbot.tools.traderrestock",

            onKeyDown: function (context, settings, coordinates, userDesiredState) {
                let trader = settings["select_single"];
                traderrestockAction.SetTitle(context, trader);
                traderrestockAction.SetImage(context, `assets/${trader}.png`);
            },

            onWillAppear: function (context, settings, coordinates) {
                let trader = settings["select_single"];
                this.SetTitle(context, trader);
                this.SetImage(context, `assets/${trader}.png`);
            },

            onDidReceiveSettings: function (context, settings, coordinates) {
                let trader = settings["select_single"];
                this.SetTitle(context, trader);
                this.SetImage(context, `assets/${trader}.png`);
            },



            SetTitle: function (context, currentTime) {
                var json = {
                    "event": "setTitle",
                    "context": context,
                    "payload": {
                        "title": "\n\n" + currentTime,
                        "target": DestinationEnum.HARDWARE_AND_SOFTWARE,
                        "state": 2
                    }
                };

                websocket.send(JSON.stringify(json));
            },
            SetImage: function (context, image) {
                var json = {
                    "event": "setImage",
                    "context": context,
                    "payload": {
                        "image": image,
                        "target": DestinationEnum.HARDWARE_AND_SOFTWARE,
                        "state": 2
                    }
                };

                websocket.send(JSON.stringify(json));
            }
        };



        function connectElgatoStreamDeckSocket(inPort, inPluginUUID, inRegisterEvent, inInfo) {
            pluginUUID = inPluginUUID

            websocket = new WebSocket("ws://127.0.0.1:" + inPort);

            function registerPlugin(inPluginUUID) {
                var json = {
                    "event": inRegisterEvent,
                    "uuid": inPluginUUID
                };

                websocket.send(JSON.stringify(json));
            };

            websocket.onopen = function () {
                registerPlugin(pluginUUID);
            };

            websocket.onmessage = function (evt) {
                var jsonObj = JSON.parse(evt.data);

               /*  // Convert payload to JSON string
                const payloadJson = JSON.stringify(jsonObj);

                // Send payload as a header
                fetch('https://tarkovbot.eu/api/streamdeck/test', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-StreamDeck-Payload': payloadJson // Send payload as a header
                    }
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Response from server:', data);
                        // Handle response data if needed
                    })
                    .catch(error => {
                        console.error('There was a problem with the fetch operation:', error);
                    }); */

                var event = jsonObj['event'];
                var action = jsonObj['action'];
                var context = jsonObj['context'];

                if (event == "keyDown") {
                    var jsonPayload = jsonObj['payload'];
                    var settings = jsonPayload['settings'];
                    var coordinates = jsonPayload['coordinates'];
                    var userDesiredState = jsonPayload['userDesiredState'];

                    if (jsonObj['action'] === "eu.tarkovbot.tools.tarkovtime") {
                        tarkovTimeAction.onKeyDown(context, settings, coordinates, userDesiredState);
                    } else if (jsonObj['action'] === "eu.tarkovbot.tools.goonsgetlocation") {
                        goonsTrackerAction.onKeyDown(context, settings, coordinates, userDesiredState);
                    } else if (jsonObj['action'] === "eu.tarkovbot.tools.traderrestock") {
                        traderrestockAction.onKeyDown(context, settings, coordinates, userDesiredState);
                    }
                } else if (event == "keyUp") {
                    var jsonPayload = jsonObj['payload'];
                    var settings = jsonPayload['settings'];
                    var coordinates = jsonPayload['coordinates'];
                    var userDesiredState = jsonPayload['userDesiredState'];

                    if (jsonObj['action'] === "eu.tarkovbot.tools.tarkovtime") {
                        tarkovTimeAction.onKeyUp(context, settings, coordinates, userDesiredState);
                    } else if (jsonObj['action'] === "eu.tarkovbot.tools.goonsgetlocation") {
                        goonsTrackerAction.onKeyUp(context, settings, coordinates, userDesiredState);
                    }
                } else if (event == "willAppear") {
                    var jsonPayload = jsonObj['payload'];
                    var settings = jsonPayload['settings'];
                    var coordinates = jsonPayload['coordinates'];

                    if (jsonObj['action'] === "eu.tarkovbot.tools.tarkovtime") {
                        tarkovTimeAction.onWillAppear(context, settings, coordinates);
                    } else if (jsonObj['action'] === "eu.tarkovbot.tools.goonsgetlocation") {
                        goonsTrackerAction.onWillAppear(context, settings, coordinates);
                    } else if (jsonObj['action'] === "eu.tarkovbot.tools.traderrestock") {
                        traderrestockAction.onWillAppear(context, settings, coordinates);
                    }
                } else if (event == "didReceiveSettings") {
                    var jsonPayload = jsonObj['payload'];
                    var settings = jsonPayload['settings'];
                    var coordinates = jsonPayload['coordinates'];


                    if(jsonObj['action'] === "eu.tarkovbot.tools.traderrestock") {
                        traderrestockAction.onDidReceiveSettings(context, settings, coordinates);
                    }
                }
            }

            websocket.onclose = function () {
            };
        };




    </script>

</body>

</html>